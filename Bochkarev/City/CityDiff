package ru.Bochkarev.City;

import java.util.HashMap;
import java.util.Map;

public class CityDiff {
    private String name;
    private Map<CityDiff, Integer> ways;

    //Конструкторы
    public CityDiff(String name) {
        this.name = name;
        this.ways = new HashMap<>();
    }

    //Создание города с дорогами
    public static CityDiff createWithRoads(String name, Object... roadData) {
        CityDiff city = new CityDiff(name);
        if (roadData.length % 2 != 0) {
            return city;
        }

        for (int i = 0; i < roadData.length; i += 2) {
            if (roadData[i] instanceof CityDiff targetCity && roadData[i + 1] instanceof Integer) {
                int distance = (Integer) roadData[i + 1];
                city.addWays(targetCity, distance);
            }
        }
        return city;
    }

    //Геттеры
    public String getName() {
        return name;
    }

    public Map<CityDiff, Integer> getWays() {
        return new HashMap<>(ways);
    }

    //Сеттер названия
    public void setName(String name) {
        this.name = name;
    }

    //Метод добавления дорог
    public void addWays(CityDiff city, int way) {
        if (city == null) {
            throw new RuntimeException("Имя не может быть пустым");
        }
        if (city == this) {
            throw new RuntimeException("Нельзя добавить дорогу из себя к себе");
        }
        if (way <= 0) {
            throw new RuntimeException("Длина дороги не может быть меньше или равной 0");
        }

        if (ways.containsKey(city) || city.ways.containsKey(this)) {
            throw new RuntimeException("Дорога между " + name + " и " + city.name + " уже существует");
        }

        ways.put(city, way);
        city.ways.put(this, way);
    }

    //Вывод дорог
    public static void printRoads(CityDiff... cities) {
        for (CityDiff city : cities) {
            System.out.print("   " + city.getName() + " → ");
            Map<CityDiff, Integer> roads = city.getWays();
            if (roads.isEmpty()) {
                System.out.println("Нет дорог");
            } else {
                boolean first = true;
                for (Map.Entry<CityDiff, Integer> road : roads.entrySet()) {
                    if (!first) System.out.print(", ");
                    System.out.print(road.getKey().getName() + " Расстояние:" + road.getValue());
                    first = false;
                }
                System.out.println();
            }
        }
    }

    //Сравнение городов по дорогам
    @Override
    public boolean equals(Object obj) {
        if (this == obj) return true;
        if (obj == null || getClass() != obj.getClass()) return false;
        CityDiff city = (CityDiff) obj;

        return sameWays(city);
    }

    @Override
    public int hashCode() {
        //return Objects.hash(name);
        int result = 1;
        for (Map.Entry<CityDiff, Integer> entry : ways.entrySet()) {
            result = 31 * result + entry.getKey().getName().hashCode();
            result = 31 * result + entry.getValue().hashCode();
        }
        return result;
    }

    //Метод проверяет одинаковые наборы дорог
    public boolean sameWays(CityDiff city) {
        if (city == null || this.ways.size() != city.ways.size())
            return false;

        for (Map.Entry<CityDiff, Integer> entry : this.ways.entrySet()) {
            CityDiff target = entry.getKey();
            Integer distance = entry.getValue();

            boolean found = false;
            for (Map.Entry<CityDiff, Integer> otherEntry : city.ways.entrySet()) {
                if (otherEntry.getKey().getName().equals(target.getName()) &&
                        otherEntry.getValue().equals(distance)) {
                    found = true;
                    break;
                }
            }

            if (!found) return false;
        }

        return true;
    }

    //Вывод
    @Override
    public String toString() {
        String result = name;
        if (!ways.isEmpty()) {
            result += " -> ";
            boolean first = true;
            for (Map.Entry<CityDiff, Integer> road : ways.entrySet()) {
                if (!first) result += ", ";
                result += road.getKey().name + ":" + road.getValue();
                first = false;
            }
        }
        return result;
    }
}
